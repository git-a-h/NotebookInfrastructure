name: CI/CD Pipeline

on:
  [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Install Micromamba and create and activate environment
        uses: mamba-org/setup-micromamba@v2
        with:
          generate-run-shell: true
          environment-file: etc/environment-lint.yml
      - name: Run Black to check code formatting
        run: |
          black src/ tests/ --check
        shell: micromamba-shell {0}
      - name: Run Ruff to check for linting issues
        run: |
          ruff check src/ tests/
        shell: micromamba-shell {0}

  run-unit-tests:
    runs-on: ubuntu-latest
    needs:
      - lint
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Install Micromamba, create and activate environment
        uses: mamba-org/setup-micromamba@v2
        with:
          generate-run-shell: true
          environment-file: etc/environment-unittests.yml
          cache-environment: true
          cache-downloads: true
      - name: Run Tests with Coverage
        run: |
          COVERAGE_FILE=.unit-coverage pytest --cov=src --cov=tests/unit tests/unit
        shell: micromamba-shell {0}
      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: .unit-coverage
          path: .unit-coverage
          include-hidden-files: true

  run-smoke-tests:
    runs-on: ubuntu-latest
    needs:
      - lint
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Install Micromamba, create and activate environment
        uses: mamba-org/setup-micromamba@v2
        with:
          generate-run-shell: true
          environment-file: etc/environment-tutorialtests.yml
      - name: Run Tests with Coverage
        run: |
          COVERAGE_FILE=.tutorial-coverage pytest --cov=src --cov=tests/tutorial tests/tutorial
        shell: micromamba-shell {0}
      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: .tutorial-coverage
          path: .tutorial-coverage
          include-hidden-files: true

  upload-notebooks:
    runs-on: ubuntu-latest
    needs: [run-smoke-tests]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Install Micromamba, create and activate environment
        uses: mamba-org/setup-micromamba@v2
        with:
          generate-run-shell: true
          environment-file: etc/environment-notebook.yml
      - name: Convert and move notebooks via bash script
        run: |
          ./scripts/convert_and_move_notebooks.sh
        shell: micromamba-shell {0}
      - name: Upload converted notebook directory as artifact
        uses: actions/upload-artifact@v4
        with:
          name: converted-notebooks
          path: notebooks/

  combine-coverage-reports:
    runs-on: ubuntu-latest
    needs: [run-unit-tests, run-smoke-tests]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Install Micromamba, create and activate environment
        uses: mamba-org/setup-micromamba@v2
        with:
          generate-run-shell: true
          environment-file: etc/environment-coverage-reports.yml
      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: *-coverage
      - name: Combine coverage reports
        run: |
          coverage combine *-coverage
          coverage html
        shell: micromamba-shell {0}
      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v5
        with:
          name: combined-coverage-report
          path: htmlcov/
